function u({mentionables:f=[]}){return{mentionables:f,showDropdown:!1,dropdownPosition:{top:0,left:0},filteredMentionables:[],selectedIndex:0,currentQuery:"",init(){this.observeForTipTapEditor(),this.$el._x_cleanups=this.$el._x_cleanups||[],this.$el._x_cleanups.push(()=>{this.cleanup()})},cleanup(){this.$el.querySelectorAll(".tiptap.ProseMirror").forEach(o=>{o._mentionContext&&delete o._mentionContext}),this.hideDropdown()},observeForTipTapEditor(){setTimeout(()=>{this.findAndObserveTipTapEditors()},100)},findAndObserveTipTapEditors(){this.$el.querySelectorAll(".fi-fo-rich-editor").forEach((o,e)=>{let i=o.querySelector(".tiptap.ProseMirror");i?this.setupMentionHandling(i,o):setTimeout(()=>{let n=o.querySelector(".tiptap.ProseMirror");n&&this.setupMentionHandling(n,o)},500)})},setupMentionHandling(t,o){let e=o.closest("[x-data]"),i=null;e&&e._x_dataStack&&(i=e._x_dataStack[0]),t.addEventListener("input",n=>{this.handleMentionInput(n,t,i)}),t.addEventListener("keyup",n=>{this.handleMentionInput(n,t,i)}),t.addEventListener("keydown",n=>{this.showDropdown&&this.handleDropdownKeydown(n,t)}),document.addEventListener("click",n=>{this.showDropdown&&!n.target.closest(".mention-dropdown")&&!n.target.closest(".tiptap")&&this.hideDropdown()}),document.addEventListener("click",n=>{n.target.closest(".mention-dropdown")&&n.stopPropagation()})},handleMentionInput(t,o,e){let i=window.getSelection();if(!i.rangeCount)return;let n=i.getRangeAt(0),s=n.startContainer;if(s.nodeType!==Node.TEXT_NODE)return;let h=s.textContent,l=n.startOffset,p=h.substring(0,l),d=p.match(/@([a-zA-Z0-9_\s]*)$/);if(d){let a=d[1],c=d[0],r=p.lastIndexOf("@");this.currentQuery=a,o._mentionContext={textNode:s,atPosition:r,cursorPosition:l,fullMatch:c,alpineData:e},this.filterMentionables(a),this.showMentionDropdown(o,n)}else this.hideDropdown(),delete o._mentionContext},filterMentionables(t){t?this.filteredMentionables=this.mentionables.filter(o=>o.name.toLowerCase().includes(t.toLowerCase())).slice(0,10):this.filteredMentionables=this.mentionables.slice(0,10),this.selectedIndex=0},showMentionDropdown(t,o){let e=o.getBoundingClientRect();if(t.closest('[wire\\:submit="updateComment"]')!==null)this.dropdownPosition={top:e.bottom+5,left:e.left};else{let n=t.closest('[x-data*="forumMentions"]');if(n){let s=n.getBoundingClientRect();this.dropdownPosition={top:e.bottom-s.top+5,left:e.left-s.left}}else this.dropdownPosition={top:e.bottom+5,left:e.left}}this.showDropdown=!0},hideDropdown(){this.showDropdown=!1,this.filteredMentionables=[],this.selectedIndex=0,this.currentQuery="";let t=this.$el.querySelector(".tiptap.ProseMirror");t&&t._mentionContext&&delete t._mentionContext},handleDropdownKeydown(t,o){switch(t.key){case"ArrowDown":t.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.filteredMentionables.length-1);break;case"ArrowUp":t.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0);break;case"Enter":case"Tab":t.preventDefault(),this.filteredMentionables[this.selectedIndex]&&this.insertMention(o,this.filteredMentionables[this.selectedIndex].id,this.filteredMentionables[this.selectedIndex].name);break;case"Escape":t.preventDefault(),this.hideDropdown();break}},clickMention(t,o,e){e||(e=this.$el.querySelector(".tiptap.ProseMirror")),e?this.insertMention(e,t,o):console.error("Could not find editor element for mention insertion")},selectMention(t){let o=this.$el.querySelector(".tiptap.ProseMirror");if(o&&o._mentionContext){console.log("Found editor with context in current scope"),this.insertMention(o,t.id,t.name);return}let e=document.querySelectorAll(".tiptap.ProseMirror");if(o&&this.showDropdown){this.insertMentionFallback(t.name);return}for(let i of e)if(i._mentionContext){this.insertMention(i,t.id,t.name);return}o?this.insertMentionFallback(t.name):console.error("No editor found at all")},insertMention(t,o,e){let i=t._mentionContext;if(!i){console.error("No mention context available"),this.insertMentionFallback(e);return}try{t.focus();let n=i.textNode,s=i.atPosition;if(!n||!n.parentNode||n.nodeType!==Node.TEXT_NODE){console.log("Text node is no longer valid, using fallback"),this.insertMentionFallback(e);return}let h=n.textContent,l=h.substring(0,s),p=h.substring(s+i.fullMatch.length),d=l+`@${e} `+p;n.textContent=d;let a=s+`@${e} `.length,c=window.getSelection();c.removeAllRanges();try{let r=document.createRange();r.setStart(n,a),r.setEnd(n,a),c.addRange(r)}catch(r){console.log("Range creation failed, but text was inserted:",r.message)}setTimeout(()=>{let r=new Event("input",{bubbles:!0});t.dispatchEvent(r)},10)}catch(n){console.error("Mention insertion failed:",n),this.insertMentionFallback(e)}delete t._mentionContext,this.hideDropdown()},insertMentionFallback(t){try{let e=window.getSelection();if(e.rangeCount>0){let i=e.getRangeAt(0),n=i.startContainer;if(n.nodeType===Node.TEXT_NODE){let s=n.textContent,h=i.startOffset,l=s.indexOf("@");if(l!==-1){let d=s.substring(0,l)+`@${t} `;n.textContent=d;let a=l+`@${t} `.length,c=document.createRange();c.setStart(n,a),c.setEnd(n,a),e.removeAllRanges(),e.addRange(c),this.hideDropdown();return}else console.log("No @ symbol found in text content")}}document.execCommand("insertText",!1,`${t} `)}catch(e){console.error("All fallback methods failed:",e)}document.querySelectorAll(".tiptap.ProseMirror").forEach(e=>delete e._mentionContext),this.hideDropdown()},highlightQuery(t,o){if(!o)return t;let e=new RegExp(`(${o})`,"gi");return t.replace(e,"<mark>$1</mark>")}}}export{u as default};
