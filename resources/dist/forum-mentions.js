function g({mentionables:p=[]}){return{mentionables:p,init(){console.log("Forum mentions Alpine component initialized"),this.initializeMentions()},initializeMentions(){console.log("Initializing mentions with data:",this.mentionables);let t=this.$el.querySelectorAll('.fi-fo-rich-editor, [data-field-wrapper-for*="content"]');if(console.log("Found rich editors:",t.length),t.length===0){let s=this.$el.querySelector('[x-data*="richEditorFormComponent"]');s?(console.log("Found fallback rich editor"),this.setupFilamentMentions(s,this.mentionables)):(console.log("No rich editor found, trying direct setup"),this.setupFilamentMentions(this.$el,this.mentionables));return}t.forEach(s=>{s._mentionables=this.mentionables,this.setupFilamentMentions(s,this.mentionables)})},setupFilamentMentions(t,s){let n=t.closest('[x-data*="richEditorFormComponent"]');if(!n){console.log("Could not find Filament RichEditor container, falling back to basic setup"),this.observeForTipTapEditor(t);return}console.log("Found Filament RichEditor container");let e=()=>{if(n._x_dataStack&&n._x_dataStack.length>0){let o=n._x_dataStack[0];o.$getEditor?(console.log("Alpine RichEditor component found"),this.setupMentionsWithFilament(t,s,o)):setTimeout(e,100)}else setTimeout(e,100)};e()},setupMentionsWithFilament(t,s,n){let e=t.querySelector(".ProseMirror")||t.closest('[x-data*="richEditorFormComponent"]').querySelector(".ProseMirror");if(!e){console.log("Could not find ProseMirror editor element");return}console.log("Setting up mentions with Filament integration"),e._mentionables=s,e._alpineData=n,e.addEventListener("input",o=>{this.handleMentionInputFilament(e,s,n)}),e.addEventListener("keyup",o=>{o.key==="@"&&(console.log("@ typed in Filament editor"),this.handleMentionInputFilament(e,s,n))})},handleMentionInputFilament(t,s,n){let e=window.getSelection();if(!e.rangeCount)return;let o=e.getRangeAt(0);if(!t.contains(o.commonAncestorContainer))return;let i=o.startContainer;if(i.nodeType!==Node.TEXT_NODE)return;let r=i.textContent,l=o.startOffset,c=r.substring(0,l),a=c.match(/@([a-zA-Z0-9_\s]*)$/);if(a){let d=a[1].toLowerCase().trim();console.log("Mention query:",d);let h=c.lastIndexOf("@");t._mentionContext={textNode:i,atPosition:h,cursorPosition:l,query:d,fullMatch:a[0],alpineData:n};let u=s.filter(m=>{let f=(m.name||"").toLowerCase();return d===""||f.includes(d)});console.log("Filtered mentionables:",u),this.showMentionDropdown(t,u,d)}else delete t._mentionContext,this.hideMentionDropdown()},observeForTipTapEditor(t){let s=new MutationObserver(e=>{e.forEach(o=>{if(o.type==="childList"){let i=t.querySelector(".ProseMirror");i&&!i._mentionsInitialized&&(i._mentionsInitialized=!0,console.log("TipTap editor found (fallback), mentionables available:",t._mentionables),i.addEventListener("input",r=>{this.handleMentionInput(i,t._mentionables||[])}),i.addEventListener("keyup",r=>{r.key==="@"&&(console.log("@ typed, mentionables:",t._mentionables),this.handleMentionInput(i,t._mentionables||[]))}),s.disconnect())}})});s.observe(t,{childList:!0,subtree:!0});let n=t.querySelector(".ProseMirror");n&&!n._mentionsInitialized&&(n._mentionsInitialized=!0,console.log("TipTap editor found immediately (fallback)"),n.addEventListener("input",e=>{this.handleMentionInput(n,t._mentionables||[])}),n.addEventListener("keyup",e=>{e.key==="@"&&this.handleMentionInput(n,t._mentionables||[])}))},handleMentionInput(t,s){let n=window.getSelection();if(!n.rangeCount)return;let e=n.getRangeAt(0);if(!t.contains(e.commonAncestorContainer))return;let o=e.startContainer;if(o.nodeType!==Node.TEXT_NODE)return;let i=o.textContent,r=e.startOffset,l=i.substring(0,r),c=l.match(/@([a-zA-Z0-9_\s]*)$/);if(c){let a=c[1].toLowerCase().trim(),d=l.lastIndexOf("@");t._mentionContext={textNode:o,atPosition:d,cursorPosition:r,query:a,fullMatch:c[0]};let h=s.filter(u=>{let m=(u.name||"").toLowerCase();return a===""||m.includes(a)});this.showMentionDropdown(t,h,a)}else delete t._mentionContext,this.hideMentionDropdown()},hideMentionDropdown(){let t=document.querySelector(".mention-dropdown");t&&t.remove()},showMentionDropdown(t,s,n){if(console.log("Showing mention dropdown with:",s),this.hideMentionDropdown(),!s||s.length===0)return;let e=document.createElement("div");e.className="mention-dropdown",e.innerHTML=s.slice(0,5).map((i,r)=>{let l=i.name||"Unknown User",c=i.id||0,a=n?l.replace(new RegExp(`(${n})`,"gi"),"<strong>$1</strong>"):l;return`
                        <div class="mention-item" data-user-id="${c}" data-user-name="${l}">
                            <div class="avatar">
                                ${l.charAt(0).toUpperCase()}
                            </div>
                            <span class="name">${a}</span>
                        </div>
                    `}).join("");let o=t.getBoundingClientRect();e.style.position="fixed",e.style.top=o.bottom+5+"px",e.style.left=o.left+"px",document.body.appendChild(e),e.querySelectorAll(".mention-item").forEach(i=>{i.addEventListener("click",()=>{let r=i.getAttribute("data-user-id"),l=i.getAttribute("data-user-name");console.log("User selected:",r,l),this.insertMentionFilament(t,r,l),this.hideMentionDropdown()})}),setTimeout(()=>{document.addEventListener("click",function i(r){e.contains(r.target)||(this.hideMentionDropdown(),document.removeEventListener("click",i))}.bind(this))},100)},insertMentionFilament(t,s,n){console.log("Attempting to insert mention with Filament:",s,n);let e=t._mentionContext;if(!e){console.error("No mention context available");return}if(e.alpineData&&e.alpineData.$getEditor){let o=e.alpineData.$getEditor();if(o){console.log("Using Filament editor to insert mention");try{o.chain().focus().deleteRange({from:o.state.selection.from-e.fullMatch.length,to:o.state.selection.from}).run(),o.chain().focus().insertContent(`@${n} `).run(),console.log("Mention inserted as plain text"),delete t._mentionContext;return}catch(i){console.error("TipTap insertion failed:",i)}}}console.log("Falling back to DOM manipulation"),this.insertMentionDOM(t,s,n,e)},insertMentionDOM(t,s,n,e){try{let o=window.getSelection(),i=o.getRangeAt(0),r=e.textNode,l=e.atPosition,c=e.cursorPosition;if(!r||r.nodeType!==Node.TEXT_NODE){if(console.log("Invalid text node, trying to find current text node"),r=i.startContainer,r.nodeType!==Node.TEXT_NODE&&(r=r.childNodes[0]),!r||r.nodeType!==Node.TEXT_NODE){console.error("Could not find valid text node");return}let u=r.textContent.lastIndexOf("@");if(u===-1){console.error("Could not find @ symbol in text node");return}l=u,c=i.startOffset}let a=document.createRange();a.setStart(r,l),a.setEnd(r,c),a.deleteContents();let d=document.createTextNode(`@${n} `);a.insertNode(d),a.setStartAfter(d),a.collapse(!0),o.removeAllRanges(),o.addRange(a),console.log("Mention inserted via DOM manipulation"),setTimeout(()=>{let h=new Event("input",{bubbles:!0});t.dispatchEvent(h)},10)}catch(o){console.error("DOM manipulation insertion failed:",o);try{document.execCommand("insertText",!1,`@${n} `),console.log("Used execCommand fallback")}catch(i){console.error("execCommand fallback also failed:",i)}}delete t._mentionContext}}}export{g as default};
